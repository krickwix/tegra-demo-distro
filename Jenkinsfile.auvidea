pipeline {
    agent {
        docker { image 'docker.io/krickwix/ybuild:v0.3' }
    }
    environment {
        BRANCH_NAME = "${GIT_BRANCH.split('/').size() > 1 ? GIT_BRANCH.split('/')[1..-1].join('/') : GIT_BRANCH}"
    }
    stages {
        stage('scm') {
            steps {
                withEnv(['LANG="C"']) {
                    sh("git submodule update --init --recursive --jobs 32")
                }
            }
        }
        stage("build") {
            steps {
                withEnv(['LANG="C"']) {
                    sh(". setup-env --machine jetson-xavier-nx-devkit-tx2-nx --distro gbeos \
                    cat >> conf/local.conf << EOF \
                    SOURCE_MIRROR_URL = "http://10.60.16.249/datastore/yocto_sources/tegra/"
                    INHERIT += "own-mirrors" 
                    EOF \
                    MACHINE=jetson-xavier-nx-devkit-tx2-nx bitbake gbeos-minimal")
                }
            }
        }
    	// stage("artefacts") {
        //     steps {
        //         archiveArtifacts artifacts: 'build/tmp/deploy/images/**/*.tegraflash.tar.gz',
        //            allowEmptyArchive: true,
        //            fingerprint: true,
        //            onlyIfSuccessful: true
        // 	minio bucket: 'gbear-yocto-images-jetson',
        //            credentialsId: 'minio_gbear-user',
        //            targetFolder: 'jenkins-build/'+BRANCH_NAME,
        //            host: 'http://hubble-minio.cisco.com',
        //            includes: 'build/tmp/deploy/images/**/*.tegraflash.tar.gz'
        //     }
    	// }
    }
    post {
        // Clean after build
        always {
            cleanWs()
        }
    }
}